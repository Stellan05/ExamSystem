<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.examsystem.mapper.TesterExamMapper">


    <select id="getAllTestersByPage" resultType="org.example.examsystem.vo.UserSimpleInfoVO">
        SELECT
            te.student_id AS userId,
            u.real_name AS realName
        FROM tester_exam te
                 JOIN user u ON te.student_id = u.id
        WHERE te.exam_id = #{examId}
          AND te.is_deleted = 0
          AND u.is_deleted = 0
        ORDER BY te.student_id
    </select>

<!--    考试参与者查询考试相关信息-->
    <select id="getExamsByTesterId" resultType="org.example.examsystem.vo.TesterExamInfoVO">
        SELECT te.id AS testerExamId,
               te.exam_id,
               te.status AS testerStatus,
               te.total_score,
               te.start_time AS testerStartTime,
               te.submit_time AS testerSubmitTime,
               e.exam_name,
               e.start_time AS examStartTime,
               e.end_time AS examEndTime,
               e.limit_minutes,
               CASE
                   WHEN NOW() &lt; e.start_time THEN 0
                   WHEN NOW() BETWEEN e.start_time AND e.end_time THEN 1
                   ELSE 2
                   END AS examStatus,
              e.paper_show AS paperShow,
               (CASE
                    WHEN EXISTS (
                        SELECT 1
                        FROM answer_record ar
                                 JOIN question q ON ar.question_id = q.id
                        WHERE ar.student_exam_id = te.id
                          AND q.question_type = 5
                          AND ar.is_reviewed = 0
                          AND ar.is_deleted = 0
                    ) THEN 0 -- 存在未批阅的主观题，返回 0
                    ELSE 1   -- 不存在未批阅的主观题（全批了或没主观题），返回 1
                   END) AS reviewStatus
        FROM tester_exam te
                 JOIN exam e ON te.exam_id = e.id
        WHERE te.student_id = #{userId} AND te.is_deleted = 0 AND e.is_deleted = 0
    </select>

<!--    出题者查询考试相关信息-->
    <select id="getExamsByCreatorId" resultType="org.example.examsystem.vo.CreatorExamInfoVO">
        SELECT id AS examId,
               exam_name,
               description,
               start_time ,
               end_time ,
               limit_minutes,
               CASE
                   WHEN NOW() &lt; exam.start_time THEN 0
                   WHEN NOW() BETWEEN exam.start_time AND exam.end_time THEN 1
                   ELSE 2
                   END AS status,
               create_time,
               update_time,
               paper_show AS showAnswer,
               exam_code as examCode
        FROM exam
        WHERE creator_id = #{userId} AND is_deleted = 0
    </select>

    <resultMap id="RankInfoMap" type="org.example.examsystem.vo.RankInfoVO">
        <result property="total" column="total"/>
        <result property="rank" column="rank"/>
    </resultMap>

    <select id="getRank" resultMap="RankInfoMap">
        SELECT
            total_count AS total,
            `rank`
        FROM (
                 SELECT
                     student_id,
                     total_score,
                     DENSE_RANK() OVER (ORDER BY total_score DESC) AS `rank`,
                     (SELECT COUNT(*)
                      FROM tester_exam
                      WHERE exam_id = #{examId} AND is_deleted = 0) AS total_count
                 FROM tester_exam
                 WHERE exam_id = #{examId}
                   AND is_deleted = 0
             ) ranked
        WHERE student_id = #{studentId}
    </select>

    <select id="getGrades" resultType="org.example.examsystem.vo.GradeInfoVO">
        SELECT
            u.id AS userId,
            u.real_name AS realName,
            te.total_score AS score,
            u.email AS email,
            te.submit_time AS submitTime,
            (CASE
                 WHEN EXISTS (
                     SELECT 1
                     FROM answer_record ar
                              JOIN question q ON ar.question_id = q.id
                     WHERE ar.student_exam_id = te.id
                       AND q.question_type = 5
                       AND ar.is_reviewed = 0
                       AND ar.is_deleted = 0
                 ) THEN 0 -- 存在未批阅的主观题，返回 0
                 ELSE 1   -- 不存在未批阅的主观题（全批了或没主观题），返回 1
                END) AS status
        FROM tester_exam te
                 JOIN user u ON te.student_id = u.id
        WHERE te.exam_id = #{examId}
          AND te.is_deleted = 0
          AND u.is_deleted = 0
        ORDER BY te.total_score DESC
    </select>

    <select id="getBasicStats" resultType="map">
        SELECT
            AVG(te.total_score) AS averageScore,
            MAX(te.total_score) AS highestScore,
            MIN(te.total_score) AS lowestScore,
            SUM(CASE WHEN te.total_score >= 60 THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS passRate
        FROM tester_exam te
        WHERE te.exam_id = #{examId}
          AND te.is_deleted = 0
          AND te.status = 2  -- 已提交的才算
    </select>

    <select id="getScoreRanges" resultType="map">
        <foreach collection="ranges" item="r" separator="UNION ALL">
            SELECT
            #{r.start} AS rangeStart,
            #{r.end} AS rangeEnd,
            SUM(CASE WHEN te.total_score BETWEEN #{r.start} AND #{r.end}
            THEN 1 ELSE 0 END) AS count,
            SUM(CASE WHEN te.total_score BETWEEN #{r.start} AND #{r.end}
            THEN 1 ELSE 0 END) * 1.0 /
            (SELECT COUNT(*) FROM tester_exam
            WHERE exam_id = #{examId}
            AND is_deleted = 0
            AND status = 2
            ) AS percentage
            FROM tester_exam te
            WHERE te.exam_id = #{examId}
            AND te.is_deleted = 0
            AND te.status = 2
        </foreach>
    </select>




</mapper>
