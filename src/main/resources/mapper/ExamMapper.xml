<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.examsystem.mapper.ExamMapper">
    <resultMap id="OptionVOResultMap" type="OptionVO">
        <result column="option_key" property="optionKey"/>
        <result column="option_text" property="optionText"/>
    </resultMap>

    <resultMap id="QuestionSimpleInfoVOResultMap" type="QuestionSimpleInfoVO">
        <id column="question_id" property="questionId"/>
        <result column="question_type" property="type"/>
        <result column="content" property="content"/>
        <result column="score" property="score"/>

        <collection property="options"
                    ofType="OptionVO"
                    select="getOptionsByQuestionId"
                    column="{questionId=question_id}"
                    fetchType="eager"/>
    </resultMap>

    <resultMap id="UserSimpleInfoVOResultMap" type="UserSimpleInfoVO">
        <id column="user_id" property="userId"/>
        <result column="real_name" property="realName"/>
    </resultMap>

    <resultMap id="CreatorExamInfoVOResultMap" type="CreatorExamInfoVO">
        <id column="exam_id" property="examId"/>
        <result column="exam_name" property="examName"/>
        <result column="description" property="description"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="status" property="status"/>
        <result column="limit_minutes" property="limitMinutes"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>

        <collection property="questionDetailVOList"
                    ofType="QuestionSimpleInfoVO"
                    resultMap="QuestionSimpleInfoVOResultMap"
                    javaType="java.util.List"
                    column="{examId=exam_id}"
                    select="getQuestionListByExamId"/>

        <collection property="userSimpleInfoVOList"
                    ofType="UserSimpleInfoVO"
                    resultMap="UserSimpleInfoVOResultMap"
                    javaType="java.util.List"
                    column="{examId=exam_id}"
                    select="getParticipantsByExamId"/>
    </resultMap>


    <select id="getExamListByCreatorId" resultMap="CreatorExamInfoVOResultMap">
        SELECT
            id AS exam_id,
            exam_name,
            description,
            start_time,
            end_time,
            status,
            limit_minutes,
            create_time,
            update_time
        FROM exam
        WHERE creator_id = #{creatorId} AND is_deleted = 0
        ORDER BY start_time DESC
    </select>

    <select id="getQuestionListByExamId" resultMap="QuestionSimpleInfoVOResultMap">
        SELECT
            eq.score,
            q.id AS question_id,
            q.question_type,
            q.content
        FROM exam_question eq
                 INNER JOIN question q ON eq.question_id = q.id
        WHERE eq.exam_id = #{examId} AND eq.is_deleted = 0
        ORDER BY eq.sort
    </select>

    <select id="getOptionsByQuestionId" resultMap="OptionVOResultMap">
        SELECT
            option_key,
            option_text
        FROM question_option
        WHERE question_id = #{questionId}
        ORDER BY option_key
    </select>

    <select id="getParticipantsByExamId" resultMap="UserSimpleInfoVOResultMap">
        SELECT
            u.id AS user_id,
            u.real_name
        FROM tester_exam te
                 INNER JOIN `user` u ON te.student_id = u.id
        WHERE te.exam_id = #{examId} AND te.is_deleted = 0
          AND u.is_deleted = 0
    </select>



</mapper>

