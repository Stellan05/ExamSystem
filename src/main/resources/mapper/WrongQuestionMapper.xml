<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.examsystem.mapper.WrongQuestionMapper">
    <select id="getWrongQuestionsByType" resultType="org.example.examsystem.vo.WrongQuestionVO">
        SELECT
            -- 错题表字段
            wt.id AS wrongQuestionId,
            wt.student_id AS studentId,
            wt.question_id AS questionId,
            wt.wrong_count AS count,
            wt.student_answer AS studentAnswer,
            wt.correct_answer AS correctAnswer,
            wt.note AS note,
            wt.create_time AS createTime,
            wt.update_time AS updateTime,

            -- 原题目字段
            q.question_type AS questionType,
            q.content AS content,
            CASE 
                WHEN GROUP_CONCAT(qo.option_key ORDER BY qo.option_key SEPARATOR '') IS NOT NULL
                THEN CONCAT('[',
                    GROUP_CONCAT(
                        CONCAT('{"option":"', qo.option_key, '","text":"', 
                            REPLACE(REPLACE(REPLACE(REPLACE(qo.option_text, '\\', '\\\\'), '"', '\\"'), '\n', '\\n'), '\r', '\\r'), 
                            '"}')
                        ORDER BY qo.option_key
                        SEPARATOR ','
                    ),
                    ']')
                ELSE NULL
            END AS optionsJson

        FROM wrong_question wt
        LEFT JOIN question q ON wt.question_id = q.id
        LEFT JOIN question_option qo ON q.id = qo.question_id
        WHERE q.question_type = #{type}
        GROUP BY wt.id, wt.student_id, wt.question_id, wt.wrong_count, 
                 wt.student_answer, wt.correct_answer, wt.note, 
                 wt.create_time, wt.update_time, q.question_type, q.content
    </select>

    <!-- 查询学生的随机错题（不含答案） -->
    <select id="getRandomWrongQuestion" resultMap="randomWrongQuestionResultMap">
        SELECT
        q.id AS questionId,
        q.content AS content,
        q.question_type AS questionType
        FROM answer_record ar
        JOIN tester_exam te ON ar.student_exam_id = te.id
        JOIN exam_question eq ON eq.exam_id = te.exam_id AND eq.question_id = ar.question_id
        JOIN question q ON q.id = ar.question_id
        WHERE te.student_id = #{studentId}
        AND ar.is_deleted = 0
        AND te.is_deleted = 0
        AND eq.is_deleted = 0
        AND q.is_deleted = 0
        AND ar.final_score &lt; eq.score
        <if test="excludeQuestionIds != null and excludeQuestionIds.size() > 0">
            AND q.id NOT IN
            <foreach collection="excludeQuestionIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        GROUP BY q.id, q.content, q.question_type
        ORDER BY RAND()
        LIMIT 1
    </select>

    <resultMap id="randomWrongQuestionResultMap" type="org.example.examsystem.vo.RandomWrongQuestionVO">
        <id property="questionId" column="questionId"/>
        <result property="content" column="content"/>
        <result property="questionType" column="questionType"/>
        <collection property="options" ofType="org.example.examsystem.vo.OptionVO"
                    select="getOptionsByQuestionIdForChoice" column="questionId"/>
    </resultMap>
</mapper>