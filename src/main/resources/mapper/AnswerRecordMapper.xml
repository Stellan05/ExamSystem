<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.examsystem.mapper.AnswerRecordMapper">

    <!-- 查询考试题目详细信息（含选项、正确答案、用户答案、得分） -->
    <select id="getQuestionDetails" resultMap="questionDetailResultMap" parameterType="map">
        SELECT
            q.id AS questionId,
            q.content AS content,
            q.question_type AS type,
            eq.score AS score,
            qa.answer_analysis AS analysis,
            qa.correct_answer AS correctAnswer,
            ar.student_answer AS userAnswer,
            ar.final_score AS userScore,
            te.id AS studentExamId
        FROM exam_question eq
                 JOIN question q ON eq.question_id = q.id
                 LEFT JOIN question_answer qa ON qa.question_id = q.id
            -- 先找到该学生针对该场考试的记录 (tester_exam)
                 LEFT JOIN tester_exam te
                           ON te.exam_id = eq.exam_id
                               AND te.student_id = #{userId}
                               AND te.is_deleted = 0
            -- 再通过 tester_exam 的主键 ID 找到答题记录
                 LEFT JOIN answer_record ar
                           ON ar.student_exam_id = te.id  AND ar.question_id = q.id
                               AND ar.is_deleted = 0
        WHERE eq.exam_id = #{examId}
          AND eq.is_deleted = 0
          AND q.is_deleted = 0
        ORDER BY eq.sort ASC
    </select>

    <resultMap id="questionDetailResultMap" type="org.example.examsystem.vo.QuestionDetailVO">

        <!-- 顶层简单属性 -->
        <result property="correctAnswer" column="correctAnswer"/>
        <result property="analysis" column="analysis"/>
        <result property="userAnswer" column="userAnswer"/>
        <result property="userScore" column="userScore"/>

        <!-- 嵌套对象 -->
        <association property="questionSimpleInfoVO" javaType="org.example.examsystem.vo.QuestionSimpleInfoVO">
            <id property="questionId" column="questionId"/>
            <result property="content" column="content"/>
            <result property="type" column="type"/>
            <result property="score" column="score"/>

            <!-- 嵌套集合：选项 -->
            <collection property="options" ofType="org.example.examsystem.vo.OptionVO"
                        select="getOptionsByQuestionIdForChoice" column="questionId"/>
        </association>

    </resultMap>


    <!-- 查询题目选项 -->
    <select id="getOptionsByQuestionIdForChoice" resultType="org.example.examsystem.vo.OptionVO" parameterType="long">
        SELECT option_key AS optionKey, option_text AS optionText
        FROM question_option
        WHERE question_id = #{questionId}
        ORDER BY id ASC
    </select>


    <select id="getTeacherReviewDetail"
            resultType="org.example.examsystem.vo.TeacherReviewQuestionDetailVO">

        SELECT
            eq.exam_id          AS examId,
            ar.question_id      AS questionId,
            te.student_id       AS studentId,
            q.question_type     AS questionType,
            q.content           AS content,
            qa.correct_answer   AS correctAnswer,
            ar.student_answer   AS studentAnswer,
            eq.score            AS score,
            ar.teacher_score    AS teacherScore,
            ar.is_reviewed      AS reviewed

        FROM answer_record ar
                 JOIN tester_exam te
                      ON ar.student_exam_id = te.id
                 JOIN exam_question eq
                      ON eq.exam_id = te.exam_id
                 JOIN question q
                      ON q.id = ar.question_id
                 LEFT JOIN question_answer qa
                           ON qa.question_id = q.id

        WHERE ar.is_deleted = 0
          AND te.is_deleted = 0
          AND eq.is_deleted = 0
          AND q.is_deleted = 0
          AND q.question_type = 5
          -- 统一使用传入的参数进行过滤
          AND te.exam_id = #{examId}
          AND te.student_id = #{studentId}
          AND ar.question_id = #{questionId}
          AND eq.question_id = #{questionId}
    </select>


    <!-- 统计考试中主观题数量（去重） -->
    <select id="countSubjectiveQuestions" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT ar.question_id)
        FROM answer_record ar
                 JOIN question q ON ar.question_id = q.id AND q.question_type = 5
                 JOIN tester_exam te ON ar.student_exam_id = te.id
        WHERE te.exam_id = #{examId}
          AND te.is_deleted = 0
          AND ar.is_deleted = 0
    </select>

    <!-- 统计每个学生已批阅的主观题数量 -->
    <select id="countReviewedPerStudent" resultType="org.example.examsystem.dto.StudentReviewCount">
        SELECT
            ar.student_exam_id AS studentExamId,
            COUNT(*) AS reviewedCount
        FROM answer_record ar
                 JOIN question q ON ar.question_id = q.id AND q.question_type = 5
                 JOIN tester_exam te ON ar.student_exam_id = te.id
        WHERE te.exam_id = #{examId}
          AND ar.is_reviewed = 1
          AND ar.is_deleted = 0
          AND te.is_deleted = 0
        GROUP BY ar.student_exam_id
    </select>

</mapper>

